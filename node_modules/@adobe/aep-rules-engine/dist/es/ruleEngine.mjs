const t={MATCHER:"matcher",GROUP:"group",HISTORICAL:"historical"},e={EQUALS:"eq",NOT_EQUALS:"ne",EXISTS:"ex",NOT_EXISTS:"nx",GREATER_THAN:"gt",GREATER_THAN_OR_EQUAL_TO:"ge",LESS_THAN:"lt",LESS_THAN_OR_EQUAL_TO:"le",CONTAINS:"co",NOT_CONTAINS:"nc",STARTS_WITH:"sw",ENDS_WITH:"ew"},n={AND:"and",OR:"or"},r={ANY:"any",ORDERED:"ordered"};function o(t){return"object"==typeof t||void 0===t}function u(t){return"number"==typeof t}const i={[e.EQUALS]:{matches:(t,e,n=[])=>{if(o(t[e]))return!1;const r=(t[e]+"").toLowerCase();for(let t=0;n.length>t;t+=1)if(!o(n[t])&&r===(n[t]+"").toLowerCase())return!0;return!1}},[e.NOT_EQUALS]:{matches:(t,e,n=[])=>{if(o(t[e]))return!1;const r=(t[e]+"").toLowerCase();for(let t=0;n.length>t;t+=1)if(!o(n[t])&&r===(n[t]+"").toLowerCase())return!1;return!0}},[e.EXISTS]:{matches:(t,e)=>null!=t[e]},[e.NOT_EXISTS]:{matches:(t,e)=>null==t[e]},[e.GREATER_THAN]:{matches:(t,e,n=[])=>{const r=t[e];if(!u(r))return!1;for(let t=0;n.length>t;t+=1)if(u(n[t])&&r>n[t])return!0;return!1}},[e.GREATER_THAN_OR_EQUAL_TO]:{matches:(t,e,n=[])=>{const r=t[e];if(!u(r))return!1;for(let t=0;n.length>t;t+=1)if(u(n[t])&&r>=n[t])return!0;return!1}},[e.LESS_THAN]:{matches:(t,e,n=[])=>{const r=t[e];if(!u(r))return!1;for(let t=0;n.length>t;t+=1)if(u(n[t])&&n[t]>r)return!0;return!1}},[e.LESS_THAN_OR_EQUAL_TO]:{matches:(t,e,n=[])=>{const r=t[e];if(!u(r))return!1;for(let t=0;n.length>t;t+=1)if(u(n[t])&&n[t]>=r)return!0;return!1}},[e.CONTAINS]:{matches:(t,e,n=[])=>{if(o(t[e]))return!1;const r=(t[e]+"").toLowerCase();for(let t=0;n.length>t;t+=1)if(!o(n[t])&&-1!==r.indexOf((n[t]+"").toLowerCase()))return!0;return!1}},[e.NOT_CONTAINS]:{matches:(t,e,n=[])=>{if(o(t[e]))return!1;const r=(t[e]+"").toLowerCase();for(let t=0;n.length>t;t+=1)if(!o(n[t])&&-1!==r.indexOf((n[t]+"").toLowerCase()))return!1;return!0}},[e.STARTS_WITH]:{matches:(t,e,n=[])=>{if(o(t[e]))return!1;const r=(t[e]+"").toLowerCase();for(let t=0;n.length>t;t+=1)if(!o(n[t])&&r.startsWith((n[t]+"").toLowerCase()))return!0;return!1}},[e.ENDS_WITH]:{matches:(t,e,n=[])=>{if(o(t[e]))return!1;const r=(t[e]+"").toLowerCase();for(let t=0;n.length>t;t+=1)if(!o(n[t])&&r.endsWith(n[t].toLowerCase()))return!0;return!1}}};function c(t){return void 0===t}const s=["iam.eventType","eventType","type"],f=["iam.id","id"];function a(t,e){for(let n=0;e.length>n;n+=1)if(!c(t[e[n]]))return t[e[n]]}function l(t,e){const n=Object.keys(t);for(let r=0;n.length>r;r+=1){const o=n[r],{event:u={}}=e;if(u[n[r]]!==t[o])return!1}return!0}function T(t,e){return{evaluate:t=>e.evaluate(t),toString:()=>`Condition{type=${t}, definition=${e}}`}}function A(t,e,n){return{evaluate:r=>{const o=function(t){return i[t]}(e);return!!o&&o.matches(r,t,n)}}}function E(t,n,o,u,i,T){return{evaluate:A=>{let E;return E=r.ORDERED===T?function(t,e,n,r){let o=n;return t.every((t=>{const n=a(t,s);if(!n)return!1;const u=e.events[n];if(!u)return!1;const i=a(t,f);if(!i)return!1;const T=u[i];if(!l(t,T))return!1;if(null===T||c(T)||0===T.count)return!1;const A=(c(o)||T.timestamp>=o)&&(c(r)||r>=T.timestamp);return o=T.timestamp,A}))?1:0}(t,A,u,i):function(t,e,n,r){return t.reduce(((t,o)=>{const u=a(o,s);if(!u)return t;const i=e.events[u];if(!i)return t;const T=a(o,f);if(!T)return t;const A=i[T];if(!A)return t;if(!l(o,A))return t;const{count:E=1}=A;return c(n)||c(r)||A.timestamp>=n&&r>=A.timestamp?t+E:t}),0)}(t,A,u,i),function(t,n,r){switch(n){case e.GREATER_THAN:return t>r;case e.GREATER_THAN_OR_EQUAL_TO:return t>=r;case e.LESS_THAN:return r>t;case e.LESS_THAN_OR_EQUAL_TO:return r>=t;case e.EQUALS:return t===r;case e.NOT_EQUALS:return t!==r;default:return!1}}(E,n,o)}}}function _(t){const{logic:e,conditions:r}=t;return function(t,e){return{evaluate:r=>n.AND===t?function(t,e){let n=!0;for(let r=0;e.length>r;r+=1)n=n&&e[r].evaluate(t);return n}(r,e):n.OR===t&&function(t,e){let n=!1;for(let r=0;e.length>r;r+=1)if(n=n||e[r].evaluate(t),n)return!0;return!1}(r,e)}}(e,r.map(S))}function S(e){const{type:n,definition:r}=e;if(t.MATCHER===n)return T(n,function(t){const{key:e,matcher:n,values:r}=t;return A(e,n,r)}(r));if(t.GROUP===n)return T(n,_(r));if(t.HISTORICAL===n)return T(n,function(t){const{events:e,from:n,to:r,matcher:o,value:u,searchType:i}=t;return E(e,o,u,n,r,i)}(r));throw Error("Can not parse condition")}function h(t){const{id:e,type:n,detail:r}=t;return function(t,e,n){return{id:t,type:e,detail:n}}(e,n,r)}function m(t){const{condition:e,consequences:n}=t;return function(t,e){return{execute:n=>t.evaluate(n)?e:[],toString:()=>`Rule{condition=${t}, consequences=${e}}`}}(S(e),n.map(h))}function O(t){const{version:e,rules:n}=function(t){const{version:e,rules:n}=t;return function(t,e){return{version:t,rules:e}}(e,n.map(m))}(t);return{execute:t=>n.map((e=>e.execute(t))).filter((t=>t.length>0)),getVersion:()=>e,numRules:()=>n.length}}export{O as default};
